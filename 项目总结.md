#### 智能供应链

##### 架构

1. 门店POS
2. 智能供应链
3. ERP(NC, U8)

##### 要货

###### 要货单

1. 增删改查
   1. 新增拆单
      - 新增时, 根据物料的采购策略对要货单进行拆分
      - 拆分为统配要货单和直配要货单
      - 原因: 不同单据的要货流程不同. 统配: 总部供货; 直配: 供应商供货
2. 生成入库单
   - 统配要货单NC直接生成入库单, 直配要货单需要手动生成(新增要货单后即可生成)
   - 根据要货单中供应商不同生成多张入库单

###### 智能要货

1. 千元用量
   - 一千元营业额所用的物料和数量
   - 选定一个日结销售日期范围和物料分类, 计算该范围内的销售额和相应各个物料的用量
   - 根据预估营业额和销售额的比例, 计算获得要货单中需要要货的物料明细和数量
2. 同期复制
   - 选择某几张要货单, 统计相关的要货信息作为本次的要货明细
3. 补足库存
   - 根据需要补足的库存方式(上限/下限/安全)和要货分类, 统计出需要补足的物料明细和数量, 并返回
4. 要货模板
   - 选择某几张要货模板, 统计相关的要货信息作为本次的要货明细
5. 普通要货
   - 选择要货分类, 将该分类中的物料添加到本次要货单的物料明细中

###### 要货模板

1. 增删改查

######要货分类

1. 增删改查

##### 盘点

###### 盘点单

1. 增删改查
   - 添加盘点单需要校验盘点单中是否有未盈亏平衡的物料

######盈亏处理

1. 盈亏处理, 生成下游出入库单

   - 根据物料的分摊方式和差异数量, 生成四张单据

     |          | 参与分摊       | 不参与分摊 |
     | -------- | -------------- | ---------- |
     | 差异 > 0 | 领料出库红冲单 | 其他入库单 |
     | 差异 < 0 | 领料出库单     | 其他出库单 |

2. 取消盈亏处理, 删除下游出入库单

   - 取消盘点单的盈亏平衡, 修改状态, 并将下游单据删除

#####菜品成本计算

- 涉及到的表
  - 日结菜品销售明细表(shop_sum_dish [SSD])
  - 菜品成本主表(dish_cost_h [DCH])
  - 菜品成本子表(dish_cost_b [DCB])
  - 盘点单主表(check [C])
  - 出库单主表(ic_out_h [IOH])
  - 出库单子表(ic_out_b [IOB])

######[定时任务]物料实际单价

1. 回写菜品成本子表中物料的实际单价
   - 查询所有菜品成本子表中 实际单价 为空的数据, 需要对这些数据进行单价回写
   - 收集上一步数据中的出库单id集合
     - 出库单id位于对应菜品成本主表中, 表示该菜品所对应的日结领料出库单
   - 根据出库单id集合查询出库单子表, 获取这些出库单上的物料信息
     - 主要为了查询物料的出库价格信息
     - 该价格由NC回写
   - 将出库单上物料信息和菜品成本子表中的物料信息进行匹配, 并进行更新操作
     - 匹配原则: 物料id和出库单id均相同
     - 使用 when then进行批量更新操作

###### [定时任务]菜品理论成本

1. 回写菜品成本主表中的菜品理论成本
   - 获取菜品成本主表中理论成本为空的菜品数据, 以及对应菜品的物料数据
   - 遍历数据, 收集物料的实际单价为空的数据的菜品id
     - 需要将收集的菜品id对应的数据删除
     - 因为这些数据不能计算菜品的理论成本
   - 计算菜品的理论成本. 公式: sum(物料的标准用量 * 物料的实际单价)
   - 更新操作
     - 将查询出来的菜品的理论成本进行批量更新
     - 将查询出来的菜品信息中实际成本为空的数据进行更新
2. 回写日结菜品销售表中的菜品理论成本
   - 更新日结菜品销售表中的菜品理论成本
   - 条件是: 单据日期相同 && 菜品id相同 && 菜品规格id相同
   - 更新日结菜品销售表中的实际成本, 方式和菜品成本实际成本方式相同

######[定时任务]菜品实际成本

1. 回写菜品成本子表中的物料用量差异, 实际用量, 分摊金额
   - 目的: 将盘点单中盘点的物料差异分摊到相应的菜品和物料中, 用于计算物料的分摊信息和菜品的实际成本
   - 流程
     - 获取所有的公司id和对应的门店id, 遍历, 进行各个门店的菜品成本计算
     - 查询出库单并关联盘点单, 找出符合条件的出库单和盘点单数据
       - 条件是: 出库类型=领料出库, 盘点单盈亏平衡=Y, 是否差异分摊=N
       - 需要对查询的数据进行非空校验, 如果为空, 则需要将该盘点单的所有数据全部清掉
     - 根据出库单id查询出库物料的单价和用量
       - 需要进行非空校验, 如果为空, 需要将对应盘点单生成的领料出库单中的所有物料全部清掉
     - 根据物料id集合, 查询该物料最近一次盘点差异分摊的时间
       - 物料所在的出库单, 关联盘点单. 条件是:  盘点单盈亏平衡=Y, 是否差异分摊=N
       - 查询结果按照物料id, 差异分摊时间 desc进行排序
     - 对盘点差异分摊时间进行处理, 得到每个物料的最近一次差异分摊时间
     - 查询当前公司和门店的第一次日结数据生成时间
       - 对查询出的结果作为处理, 转换为map, 将物料id作为key, 方便查询
       - 如果有些物料没有最近一次差异分摊时间, 则将该时间作为本次差异分摊的开始时间
     - 遍历第三步查询出的物料id信息, 向其中添加最近一次差异分摊时间. 作为本次差异分摊的开始时间
     - 执行一次菜品理论成本计算的定时任务, 保证菜品理论成本有值, 为计算实际成本做准备
     - 从所有的差异分摊时间中获取时间最早的差异分摊时间
     - 以上一步中获取的时间到当前时间为区间, 获取这个区间内的日结数据
       - 包含营业日期, 菜品成本主表id, 菜品成本子表id, 菜品id, 理论成本, 物料id, 物料用量等信息
       - 对数据进行非空校验, 如果为空, 则直接抛异常, 不能进行菜品成本计算
       - 将查询出的数据进行转换, 转换为: 一个营业日期包含菜品集合, 一个菜品包含物料集合
     - 进行成本分摊
     - 遍历第三步查询出的物料信息, 逐一进行分摊
     - 获取当前物料的最后一次差异分摊时间到当前时间的菜品信息
     - 遍历菜品信息, 再遍历物料信息, 根据物料的分摊规则进行分摊
     - 按用量分摊: 当前菜品分摊量 = 当前菜品销量\*物料用量 / SUM(用到该物料的菜品销量\*物料用量)
     - 按金额分摊: 当前菜品分摊量 = 当前菜品销售额 / SUM(用到该物料的菜品销售额)
     - 公共料分摊: 当前菜品分摊量 = 当前菜品物料总用量 / SUM(所有菜品的物料总用量)
     - 实际用量 = 标准用量 + 用量差异
     - 分摊金额 = 用量差异 * 实际单价
     - 遍历菜品, 计算实际成本
       - 菜品实际成本 = 理论成本 + SUM(分摊金额)
     - 批量更新菜品成本子表, 菜品成本主表, 日结菜品销售表
     - 对于公共料, 由于日结领料出库不会生成公共料信息, 需要在分摊的时候在菜品成本子表中插入公共料信息
2. 回写菜品成本主表中菜品的实际成本
   - 菜品实际成本 = 理论成本 + SUM(分摊金额)
3. 回写日结菜品销售表中的菜品实际成本

######菜品成本展示

1. 查看菜品在某个区间内的成本统计
2. 查看单一菜品在某个区间内的每天成本明细

##### 算法

1. 多级数据 分类并封装为Map或Bean

   - 目的: 转为map, 提高查询效率
   - 使用场景
     - 物料的供应商集合/辅计量单位集合转换. 参考: `ScmMaterialInfoServiceImpl.convertListInfoToMap(List<T> listInfo);`
       - 物料id, 供应商/辅计量信息两层
     - 菜品/物料信息转换. 参考: `DishCostAccountServiceImpl.convertMapToListOfModel(List<Map<String, Object>> dataList);`
       - 营业日期, 菜品id, 物料信息三层
   - 算法实现(以物料的供应商/辅计量单位转换为例)
     1. 创建一个局部变量, 指向当前物料id
     2. 创建一个集合, 用于保存当前物料下的内层数据
     3. 创建一个物料map, 存入第2的集合
     4. 遍历, 如果物料相同, 则创建map并存入集合
     5. 如果物料不同, 则将集合存入物料map, key为物料id, value为集合
     6. 场景2类似, 只是在遍历内需要进行两层判断, 先判断日期, 在判断菜品id

##### 代码优化

1. 提取公共代码

   - 创建通用接口和服务, 如物料查询接口
   - 物料查询接口提供了供应商集合, 辅计量单位集合等物料相关的查询服务
   - 请求参数Map的验证
   - SQL结果集Map的验证

2. 提取工具类

   1. beanToMap: 将bean中所有的getter方法转为map中的元素

      - 参考: `ScmMaterialInfoServiceImpl.beanToMap(Object bean)`
      - 通过`getDeclaredMethods()`获取bean中所有的方法
      - 遍历方法, 如果以get开头, 并且方法名长度大于3, 则进行截取
      - 截取方法名, 获得key, 调用方法, 得到value

   2. 逗号隔开的字符串转数组

      - 使用String的split()方法
      - 如果是以点号分割, 则不可以使用该方法

##### 技术亮点

1. 分页拦截器
2. 泛型使用
   - 代码通用
   - 扩展性强
3. 反射使用
   1. 获取字节码的方式
      - 类名.class
      - bean.getClass()
      - Class.forName("类名")

#### 拓展系统

##### 工作日历

- 存入每天信息. 包含年月日, 是否工作日等信息